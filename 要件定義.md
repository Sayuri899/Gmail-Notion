# Gmail → Notion 自動連携ツール 要件定義書

## 1. システム概要

### 1.1 目的
- Gmailの特定ラベル付きメールを自動的にNotionデータベースに転送する
- メール処理の自動化により、手作業を削減し効率化を図る
- 処理状況の可視化と管理機能を提供する

### 1.2 プラットフォーム
- **実行環境**: Google Apps Script (GAS)
- **UI**: Google スプレッドシート
- **連携先**: Gmail API、Notion API

## 2. 機能要件

### 2.1 メイン機能

#### 2.1.1 メール自動転送機能
- **対象**: 指定されたGmailラベルが付いたメール
- **転送先**: 指定されたNotionデータベース
- **転送内容**:
  - メール件名（Notionページのタイトル）
  - 送信者情報
  - 受信日時
  - メッセージID
  - 本文（最大2,000文字、超過時は切り詰め）

#### 2.1.2 処理後動作制御
- **ラベル削除**: 処理後に元のラベルを削除
- **完了ラベル追加**: 元ラベル削除後、処理済みラベルを追加
- **アーカイブ**: ラベル削除後、メールをアーカイブ

### 2.2 ユーザーインターフェース機能

#### 2.2.1 メニューシステム
- **初期設定**: 必要なシートとヘッダーの自動作成
- **接続テスト**: Notion API、Gmailラベルの接続確認
- **手動実行**: ユーザー操作による即座の処理実行
- **自動実行設定**: 定期実行トリガーの設定
- **自動実行停止**: トリガーの無効化
- **ログ確認**: 処理統計の表示
- **デバッグ情報**: システム状態の詳細確認

#### 2.2.2 設定管理
- **設定項目**:
  - NotionデータベースID
  - Notionシークレットトークン
  - Notionタイトルプロパティ名
  - Gmailラベル名
  - 処理後の動作
  - 完了ラベル名
  - 処理間隔（分）

### 2.3 ログ・統計機能

#### 2.3.1 処理ログ
- **記録項目**: 処理日時、メール件名、送信者、ステータス、エラー内容、処理時間
- **ログ制限**: 最大1,000件（古いログは自動削除）

#### 2.3.2 統計情報
- **統計項目**:
  - 総処理件数
  - 成功件数
  - エラー件数
  - 成功率
  - 最新処理日時
  - 平均処理時間
  - 今日の処理件数

### 2.4 自動実行機能

#### 2.4.1 スケジュール実行
- **設定可能間隔**: 1分〜1440分（24時間）
- **トリガー管理**: 既存トリガーの自動削除・再設定
- **実行制限**: 1回の実行で最大50件のメール処理

## 3. 非機能要件

### 3.1 パフォーマンス要件
- **処理時間制限**: 最大5分で処理を中断
- **メール処理上限**: 1回の実行で最大50件
- **API制限対応**: Notion API制限に配慮した処理間隔

### 3.2 エラーハンドリング
- **設定値検証**: 必須項目の入力チェック
- **API接続エラー**: レスポンスコードによる成功・失敗判定
- **重複処理防止**: メッセージIDベースの重複チェック
- **フォールバック処理**: エラー時の代替処理実行

### 3.3 セキュリティ要件
- **認証**: Google Apps Scriptの認証機能を使用
- **トークン管理**: スプレッドシート内での機密情報管理
- **アクセス制御**: スプレッドシート所有者のみがアクセス可能

### 3.4 可用性要件
- **自動復旧**: エラー発生時の継続処理
- **ログ保持**: 処理履歴の永続化
- **状態監視**: デバッグ機能による状態確認

## 4. データ要件

### 4.1 入力データ
- **Gmail**: ラベル付きメールの件名、本文、送信者、受信日時、メッセージID
- **設定**: ユーザーが入力する各種設定値

### 4.2 出力データ
- **Notion**: ページタイトル、本文ブロック（送信者、日時、本文を含む）
- **ログ**: 処理結果の詳細記録
- **統計**: 処理状況の集計データ

### 4.3 データ制限
- **メール本文**: 最大2,000文字（Notion API制限対応）
- **ログ保持**: 最大1,000件
- **バッチ処理**: 1回最大50件

## 5. 制約条件

### 5.1 技術制約
- Google Apps Scriptの実行時間制限（6分）
- Notion API のレート制限
- Gmail API のクォータ制限

### 5.2 運用制約
- スプレッドシートへのアクセス権限が必要
- Notion APIトークンの事前取得が必要
- Gmailラベルの事前設定が必要

## 6. 品質要件

### 6.1 信頼性
- エラー発生時の適切なログ記録
- 部分的処理失敗時の継続実行
- 重複処理の防止

### 6.2 使いやすさ
- 直感的なメニューインターフェース
- 分かりやすいエラーメッセージ
- 設定項目の詳細ガイド

### 6.3 保守性
- モジュール化された関数構造
- 詳細なログ出力
- デバッグ機能の充実

## 7. インターフェース要件

### 7.1 外部API
- **Notion API v2022-06-28**: ページ作成、データベース情報取得
- **Gmail API**: メール検索、ラベル操作

### 7.2 ユーザーインターフェース
- **Google スプレッドシート**: 設定管理、ログ表示、統計表示
- **メニューバー**: 各機能へのアクセスポイント

## 8. 運用要件

### 8.1 初期設定手順
1. 初期設定メニューの実行
2. 設定シートへの必要情報入力
3. 接続テストの実行
4. 自動実行設定（オプション）

### 8.2 日常運用
- 定期的なログ確認
- エラー発生時の原因調査
- 設定変更時の接続テスト実行

### 8.3 メンテナンス
- ログの定期的な確認
- 統計データの分析
- 必要に応じた設定調整
